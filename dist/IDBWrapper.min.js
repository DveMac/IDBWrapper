/*! IDBWrapper - v0.1.0 - 2012-05-09
* https://github.com/Dave/IDBWrapper
* Copyright (c) 2012 DveMac; Licensed MIT */
(function(a){a(function(){function e(){}function f(b){var c=new e;return c.then=function(a){var c;try{return a&&(c=a(b)),l(c===d?b:c)}catch(e){return g(e)}},a(c)}function g(b){var c=new e;return c.then=function(a,c){var e;try{return c?(e=c(b),l(e===d?b:e)):g(b)}catch(f){return g(f)}},a(c)}function h(a){return k(a,function(a){return g(a)})}function i(){function n(a,b,c){return k(a,b,c)}function o(a){m(f(a))}function p(a){m(g(a))}function q(a){l(a)}var b,c,h,j,k,l,m;return h=[],j=[],k=function(a,b,c){var d=i();return h.push(function(c){c.then(a,b).then(d.resolve,d.reject,d.progress)}),c&&j.push(c),d.promise},l=function(a){var b,c=0;while(b=j[c++])b(a)},m=function(a){var b,c=0;k=a.then,m=l=function(){throw new Error("already completed")},j=d;while(b=h[c++])b(a);h=[]},b={},c=new e,c.then=b.then=n,b.promise=a(c),b.resolver=a({resolve:b.resolve=o,reject:b.reject=p,progress:b.progress=q}),b}function j(a){return a&&typeof a.then=="function"}function k(a,b,c,d){var e=l(a);return e.then(b,c,d)}function l(a){var b,c;return a instanceof e?b=a:(c=i(),j(a)?(a.then(c.resolve,c.reject,c.progress),b=c.promise):(c.resolve(a),b=c.promise)),b}function m(a,b,c,d,e){return v(2,arguments),k(a,function(a){function q(a){l(a)}function r(a){m(a)}function s(a){n(a)}function t(){l=m=n=w}var f,g,h,j,l,m,n,o,p;o=a.length>>>0,f=Math.max(0,Math.min(b,o)),g=[],j=i(),h=k(j,c,d,e);if(!f)j.resolve(g);else{l=function(a){g.push(a),--f||(t(),j.resolve(g))},m=function(a){t(),j.reject(a)},n=j.progress;for(p=0;p<o;++p)p in a&&k(a[p],q,r,s)}return h})}function n(a,b,c,d){return v(1,arguments),k(a,function(a){return t(a,o,[])}).then(b,c,d)}function o(a,b,c){return a[c]=b,a}function p(a,b,c,d){function e(a){return b?b(a[0]):a[0]}return m(a,1,e,c,d)}function q(a,b){return k(a,function(a){return r(a,b)})}function r(a,b){var c,d,e;d=a.length>>>0,c=new Array(d);for(e=0;e<d;e++)e in a&&(c[e]=k(a[e],b));return t(c,o,c)}function s(a,b,e){var f=c.call(arguments,1);return k(a,function(a){return t.apply(d,[a].concat(f))})}function t(a,c,d){var e,f;return e=a.length,f=[function(a,b,d){return k(a,function(a){return k(b,function(b){return c(a,b,d,e)})})}],arguments.length>2&&f.push(d),b.apply(a,f)}function u(a,b,c){var d=arguments.length>2;return k(a,function(a){return d&&(a=c),b.resolve(a),a},function(a){return b.reject(a),g(a)},b.progress)}function v(a,b){var c,d=b.length;while(d>a){c=b[--d];if(c!=null&&typeof c!="function")throw new Error("callback is not a function")}}function w(){}var a,b,c,d;return k.defer=i,k.reject=h,k.isPromise=j,k.all=n,k.some=m,k.any=p,k.map=q,k.reduce=s,k.chain=u,a=Object.freeze||function(a){return a},e.prototype=a({always:function(a,b){return this.then(a,a,b)}}),c=[].slice,b=[].reduce||function(a){var b,c,d,e,f;f=0,b=Object(this),e=b.length>>>0,c=arguments;if(c.length<=1)for(;;){if(f in b){d=b[f++];break}if(++f>=e)throw new TypeError}else d=c[1];for(;f<e;++f)f in b&&(d=a(d,b[f],f,b));return d},k})})(typeof define=="function"?define:function(a){typeof module!="undefined"?module.exports=a():this.when=a()})